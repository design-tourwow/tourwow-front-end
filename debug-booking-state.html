<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Booking State</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin: 20px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .debug-title {
            color: #2563eb;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e5e7eb;
        }
        pre {
            background: #f3f4f6;
            border-radius: 6px;
            padding: 12px;
            overflow-x: auto;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .test-result {
            padding: 12px;
            border-radius: 6px;
            margin: 8px 0;
        }
        .success { background: #d1fae5; border: 1px solid #10b981; color: #065f46; }
        .error { background: #fee2e2; border: 1px solid #ef4444; color: #991b1b; }
        .warning { background: #fef3c7; border: 1px solid #f59e0b; color: #92400e; }
        .info { background: #dbeafe; border: 1px solid #3b82f6; color: #1e40af; }
        .console-log {
            background: #1f2937;
            color: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin: 16px 0;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin: 4px;
        }
        button:hover { background: #2563eb; }
        .highlight { background: yellow; padding: 2px 4px; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>üîç Debug Booking State - Tour Search 24</h1>
    
    <div class="debug-section">
        <h2 class="debug-title">üìä Real-time State Check</h2>
        <button onclick="testCurrentState()">üîÑ Test Current State</button>
        <button onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
        <button onclick="openDevtools()">üîß Open DevTools</button>
        
        <div id="state-results"></div>
    </div>

    <div class="debug-section">
        <h2 class="debug-title">üìã Expected vs Actual Data</h2>
        <div class="test-result info">
            <strong>‚úÖ Expected Data:</strong><br>
            Date Range: "12‚Äì20 ‡∏û.‡∏¢. 2568"<br>
            Price: ‡∏ø39,999<br>
            Status: available<br>
            Seats Left: 12
        </div>
        <div id="actual-data"></div>
    </div>

    <div class="debug-section">
        <h2 class="debug-title">üñ•Ô∏è Console Logs Monitor</h2>
        <div class="console-log" id="console-output">
            <div>üéØ Monitoring console logs...</div>
            <div>üì± Open DevTools to see real-time logs</div>
        </div>
    </div>

    <div class="debug-section">
        <h2 class="debug-title">üîç Element Inspection</h2>
        <div id="element-inspection">
            <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>
    </div>

    <script>
        // Override console.log to capture logs
        const originalLog = console.log;
        const logBuffer = [];
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${args.join(' ')}`;
            logBuffer.push(logEntry);
            
            if (logBuffer.length > 50) {
                logBuffer.shift(); // Keep only last 50 logs
            }
            
            updateConsoleDisplay();
        };

        function updateConsoleDisplay() {
            const consoleEl = document.getElementById('console-output');
            if (consoleEl) {
                consoleEl.innerHTML = logBuffer
                    .slice(-20) // Show last 20 logs
                    .map(log => {
                        // Highlight important logs
                        if (log.includes('üîç') || log.includes('üéØ') || log.includes('‚ùå')) {
                            return `<div class="highlight">${log}</div>`;
                        }
                        return `<div>${log}</div>`;
                    })
                    .join('');
                consoleEl.scrollTop = consoleEl.scrollHeight;
            }
        }

        function testCurrentState() {
            const resultsEl = document.getElementById('state-results');
            const actualEl = document.getElementById('actual-data');
            
            try {
                // Test if page exists
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = 'http://localhost:4000/tour-search-24/tour-turkey-009';
                document.body.appendChild(iframe);
                
                iframe.onload = function() {
                    try {
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        
                        // Check for booking elements
                        const stickyBar = iframeDoc.querySelector('.fixed.bottom-0');
                        const dateElements = iframeDoc.querySelectorAll('[class*="date"], [class*="calendar"]');
                        const priceElements = iframeDoc.querySelectorAll('[class*="price"], [class*="‡∏ø"]');
                        
                        let results = '<div class="test-result">';
                        
                        if (stickyBar) {
                            results += '<div class="success">‚úÖ Sticky booking bar found</div>';
                            results += `<div class="info">üì± Bar content: ${stickyBar.textContent.substring(0, 100)}...</div>`;
                        } else {
                            results += '<div class="error">‚ùå Sticky booking bar NOT found</div>';
                        }
                        
                        results += `<div class="info">üìÖ Date elements found: ${dateElements.length}</div>`;
                        results += `<div class="info">üí∞ Price elements found: ${priceElements.length}</div>`;
                        
                        // Extract actual text content
                        let actualData = '<div class="test-result warning">';
                        actualData += '<strong>üîç Actual Data Found:</strong><br>';
                        
                        dateElements.forEach((el, i) => {
                            const text = el.textContent.trim();
                            if (text && text !== '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á') {
                                actualData += `Date ${i+1}: "${text}"<br>`;
                            }
                        });
                        
                        priceElements.forEach((el, i) => {
                            const text = el.textContent.trim();
                            if (text && text.includes('‡∏ø')) {
                                actualData += `Price ${i+1}: "${text}"<br>`;
                            }
                        });
                        
                        actualData += '</div>';
                        
                        results += '</div>';
                        resultsEl.innerHTML = results;
                        actualEl.innerHTML = actualData;
                        
                    } catch (e) {
                        resultsEl.innerHTML = `<div class="error">‚ùå Error accessing iframe content: ${e.message}</div>`;
                    } finally {
                        document.body.removeChild(iframe);
                    }
                };
                
                iframe.onerror = function() {
                    resultsEl.innerHTML = '<div class="error">‚ùå Failed to load tour page</div>';
                    document.body.removeChild(iframe);
                };
                
            } catch (error) {
                resultsEl.innerHTML = `<div class="error">‚ùå Test error: ${error.message}</div>`;
            }
        }

        function clearLogs() {
            logBuffer.length = 0;
            updateConsoleDisplay();
        }

        function openDevtools() {
            window.open('http://localhost:4000/tour-search-24/tour-turkey-009', '_blank');
            alert('üì± ‡πÄ‡∏õ‡∏¥‡∏î DevTools (F12) ‡πÅ‡∏•‡πâ‡∏ß‡∏î‡∏π Console tab ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö logs ‡πÅ‡∏ö‡∏ö real-time');
        }

        // Auto-check every 5 seconds
        let autoCheckCount = 0;
        setInterval(() => {
            if (autoCheckCount < 5) { // Limit to 5 auto-checks
                testCurrentState();
                autoCheckCount++;
                console.log(`üîÑ Auto-check ${autoCheckCount}/5 completed`);
            }
        }, 5000);

        // Initial test
        setTimeout(testCurrentState, 1000);

        // Element inspection
        function inspectElements() {
            const inspectionEl = document.getElementById('element-inspection');
            
            fetch('http://localhost:4000/tour-search-24/tour-turkey-009')
                .then(response => response.text())
                .then(html => {
                    // Search for specific patterns
                    const patterns = [
                        { name: 'StickyBookingBar', regex: /StickyBookingBar/g },
                        { name: 'Date Range Pattern', regex: /\d+‚Äì\d+\s+[‡∏Å-‡∏Æ]+\.\s+\d+/g },
                        { name: 'Price Pattern', regex: /‡∏ø[\d,]+/g },
                        { name: 'selectedDeparture', regex: /selectedDeparture/g },
                        { name: 'Departure Data', regex: /"date_range":\s*"[^"]+"/g }
                    ];
                    
                    let results = '';
                    patterns.forEach(pattern => {
                        const matches = html.match(pattern.regex) || [];
                        results += `<div class="${matches.length > 0 ? 'success' : 'warning'}">`;
                        results += `<strong>${pattern.name}:</strong> ${matches.length} matches<br>`;
                        if (matches.length > 0) {
                            results += `<pre>${matches.slice(0, 3).join('\n')}</pre>`;
                        }
                        results += '</div>';
                    });
                    
                    inspectionEl.innerHTML = results;
                })
                .catch(error => {
                    inspectionEl.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                });
        }

        setTimeout(inspectElements, 2000);
    </script>
</body>
</html>